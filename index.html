<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#f0f0f0">
    <title>B2ÂÅúËªäÂ†¥Â∞éËà™</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="apple-touch-icon" href="icon.png">

    <style>
        body { margin: 0; padding: 0; background: #eee; overflow: hidden; }
        #map { height: 100vh; width: 100vw; background-color: #f0f0f0; }
        
        .search-container {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95); padding: 8px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); width: 250px;
            font-family: sans-serif;
        }
        #routeStatus {
            font-size: 15px; margin-bottom: 6px; text-align: center; display: none;
            background: #fff5f5; padding: 4px; border-radius: 6px;
            border: 1px solid #fab1a0; font-weight: bold; color: #d63031;
        }
        #combinedInput {
            width: 100%; height: 38px; font-size: 18px; text-align: center;
            border: 2px solid #ccc; border-radius: 8px;
            background: #fff; box-sizing: border-box; cursor: pointer; margin-bottom: 6px;
        }
        .keypad { display: none; flex-direction: row; gap: 6px; }
        .keypad.active { display: flex; }
        
        /* Â≠óÊØçÁõ¥Âàó */
        .keypad-letters { display: flex; flex-direction: column; gap: 4px; flex: 0.7; }
        .keypad-main { display: flex; flex-direction: column; gap: 4px; flex: 3; }
        .key-row { display: flex; justify-content: space-between; gap: 4px; }
        
        .key-btn {
            flex: 1; height: 40px; font-size: 15px; font-weight: bold;
            cursor: pointer; border: 1px solid #bbb; border-radius: 5px;
            background: #ffffff; color: #333; display: flex; align-items: center; justify-content: center;
        }
        .key-btn:active { background: #ddd; transform: scale(0.95); }

        /* Â†¥È§®Â∞àÂ±¨Ëâ≤ */
        .btn-a { background-color: #DABE00 !important; color: white; border: none; }
        .btn-b { background-color: #E98B19 !important; color: white; border: none; }
        .btn-c { background-color: #E50012 !important; color: white; border: none; }
        .btn-d { background-color: #0072BE !important; color: white; border: none; }
        .btn-e { background-color: #2B8D56 !important; color: white; border: none; }

        .key-btn.func { font-size: 13px; border: 1px solid #999; }
        .key-btn.func-clear { background: #fff5f5; color: #e03131; border-color: #ffa8a8; }
        .key-btn.func-search { background: #f4fce3; color: #2f9e44; border-color: #c0eb75; }
        .key-btn.nav-point { background-color: #f1f2f6; color: #444; border: 2px solid #ddd; }
    </style>
</head>
<body>

<div class="search-container">
    <div id="routeStatus"></div>
    <input type="text" id="combinedInput" placeholder="ÈªûÊìäÈñãÂßã" readonly onclick="toggleKeypad()">
    
    <div id="keypadSection" class="keypad">
        <div class="keypad-letters">
            <button class="key-btn btn-a" onclick="appendKey('A')">A</button>
            <button class="key-btn btn-b" onclick="appendKey('B')">B</button>
            <button class="key-btn btn-c" onclick="appendKey('C')">C</button>
            <button class="key-btn btn-d" onclick="appendKey('D')">D</button>
            <button class="key-btn btn-e" onclick="appendKey('E')">E</button>
        </div>
        
        <div class="keypad-main">
            <div class="key-row"><button class="key-btn" onclick="appendKey('1')">1</button><button class="key-btn" onclick="appendKey('2')">2</button><button class="key-btn" onclick="appendKey('3')">3</button></div>
            <div class="key-row"><button class="key-btn" onclick="appendKey('4')">4</button><button class="key-btn" onclick="appendKey('5')">5</button><button class="key-btn" onclick="appendKey('6')">6</button></div>
            <div class="key-row"><button class="key-btn" onclick="appendKey('7')">7</button><button class="key-btn" onclick="appendKey('8')">8</button><button class="key-btn" onclick="appendKey('9')">9</button></div>
            <div class="key-row">
                <button class="key-btn func func-clear" onclick="clearInput()">Ê∏ÖÈô§</button>
                <button class="key-btn" onclick="appendKey('0')">0</button>
                <button class="key-btn func func-search" onclick="executeSearch()">ÊêúÂ∞ã</button>
            </div>
            <div class="key-row">
                <button class="key-btn func nav-point" style="border-color:#0984e3" onclick="setPoint('from')">Âßã</button>
                <button class="key-btn func nav-point" style="border-color:#d63031" onclick="setPoint('to')">ÁµÇ</button>
            </div>
        </div>
    </div>
</div>

<div id="map"></div>

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js'); });
    }

    // --- 1. Ë≥áÊñôÂÆöÁæ© ---
    const imageBounds = [[22.62193, 120.34105], [22.62406, 120.34360]];
    const roadNetwork = {
        "nodes": {
            "A1": [120.34124, 22.62270], "A3": [120.34137, 22.62307], "A4": [120.34149, 22.62344], "A5": [120.34164, 22.62391],
            "B1": [120.34175, 22.62254], "B3": [120.34188, 22.62290], "B4": [120.34200, 22.62327], "B5": [120.34216, 22.62374],
            "C1": [120.34250, 22.62227], "C2": [120.34256, 22.62244], "C3": [120.34263, 22.62266], "C4": [120.34275, 22.62301], "C5": [120.34291, 22.62348],
            "D1": [120.34308, 22.62208], "D2": [120.34313, 22.62225], "D4": [120.34332, 22.62282], "D5": [120.34347, 22.62329]
        },
        "edges": [
            ["A1","A3"], ["A3","A4"], ["A4","A5"], ["B1","B3"], ["B3","B4"], ["B4","B5"],
            ["C1","C2"], ["C2","C3"], ["C3","C4"], ["C4","C5"], ["D1","D2"], ["D2","D4"], ["D4","D5"],
            ["A1","B1"], ["B1","C1"], ["C1","D1"], ["C2","D2"], ["A3","B3"], ["B3","C3"],
            ["A4","B4"], ["C4","D4"], ["A5","B5"], ["B5","C5"], ["C5","D5"]
        ]
    };

    const redFlagIcon = L.divIcon({
        html: '<div style="font-size: 38px; filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.3));">üö©</div>',
        className: '', iconSize: [40, 40], iconAnchor: [10, 38]
    });

    let geojsonLayer, currentInput = "", activeSpot = null;
    let startData = null, endData = null, routeLine = null, startMarker = null, endMarker = null;

    const map = L.map('map', { center: [22.6231, 120.3425], zoom: 18, maxZoom: 24, minZoom: 15, zoomControl: false });
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { opacity: 0.4, maxZoom: 24, maxNativeZoom: 19 }).addTo(map);
    L.imageOverlay('B2-20250921.svg', imageBounds, { opacity: 0.8, interactive: false }).addTo(map);

    fetch('parking.geojson').then(res => res.json()).then(data => {
        geojsonLayer = L.geoJSON(data, {
            pointToLayer: (f, l) => L.circleMarker(l, { radius: 3, fillColor: "#ff9800", color: "#000", weight: 1, opacity: 0.3, fillOpacity: 0.5 }),
            style: () => ({ color: "#3388ff", opacity: 0.1, weight: 1, fillOpacity: 0 }),
            onEachFeature: (f, layer) => layer.bindPopup("ÂêçÁ®±: " + f.properties.name)
        }).addTo(map);
    });

    // --- 2. Ê†∏ÂøÉÁÆóÊ≥ïÂÑ™ÂåñÔºöÁ¥îË∑ùÈõ¢Â∞éËà™ ---

    function formatInput(val) {
        val = val.toUpperCase();
        if (val.length === 2 && /[A-E]/.test(val[0]) && /\d/.test(val[1])) return val[0] + '0' + val[1];
        return val;
    }

    function calcDist(p1, p2) {
        // ÊîæÂ§ßÂÄçÁéá‰ª•Á≤æÁ¢∫ÊØîËºÉÂæÆÂ∞èÂ∑ÆÂÄº
        return Math.sqrt(Math.pow(p1[0] - p2[0], 2) + Math.pow(p1[1] - p2[1], 2)) * 100000;
    }

    function dijkstra(start, end) {
        const graph = {};
        for (let id in roadNetwork.nodes) graph[id] = {};
        roadNetwork.edges.forEach(([u, v]) => {
            const d = calcDist(roadNetwork.nodes[u], roadNetwork.nodes[v]);
            graph[u][v] = d; graph[v][u] = d;
        });

        const dists = {}, prevs = {}, pq = new Set(Object.keys(graph));
        Object.keys(graph).forEach(n => dists[n] = Infinity);
        dists[start] = 0;

        while(pq.size) {
            let u = Array.from(pq).reduce((a, b) => dists[a] < dists[b] ? a : b);
            if (u === end || dists[u] === Infinity) break;
            pq.delete(u);
            for (let v in graph[u]) {
                let alt = dists[u] + graph[u][v]; // Á¥îË∑ùÈõ¢Ë®àÁÆóÔºå‰∏çË®≠Êá≤ÁΩ∞
                if (alt < dists[v]) { dists[v] = alt; prevs[v] = u; }
            }
        }
        const path = []; let curr = end;
        while(curr) { path.unshift(curr); curr = prevs[curr]; }
        return path;
    }

    function getProjectionPoint(P, A, B) {
        const x1 = A[0], y1 = A[1], x2 = B[0], y2 = B[1], px = P.lng, py = P.lat;
        const dx = x2 - x1, dy = y2 - y1;
        let t = Math.max(0, Math.min(1, ((px - x1) * dx + (py - y1) * dy) / (dx * dx + dy * dy)));
        return [x1 + t * dx, y1 + t * dy];
    }

    function getNearestPathInfo(latlng) {
        let minD = Infinity, best = null;
        roadNetwork.edges.forEach(([u, v]) => {
            const proj = getProjectionPoint(latlng, roadNetwork.nodes[u], roadNetwork.nodes[v]);
            const d = calcDist([latlng.lng, latlng.lat], proj);
            if (d < minD) { minD = d; best = { proj, nodes: [u, v] }; }
        });
        return best;
    }

    function drawRoute() {
        if (routeLine) map.removeLayer(routeLine);
        const sInfo = getNearestPathInfo(startData.pos), eInfo = getNearestPathInfo(endData.pos);
        if (!sInfo || !eInfo) return;

        let bestPath = null, minTotalDist = Infinity;

        // ÂêåÊôÇË©ï‰º∞ÂõõÁ®ÆÁµÑÂêàÔºåÊâæÂá∫ÊúÄÁü≠Á∏ΩÈáåÁ®ã
        sInfo.nodes.forEach(sNode => {
            eInfo.nodes.forEach(eNode => {
                const path = dijkstra(sNode, eNode);
                let total = calcDist([startData.pos.lng, startData.pos.lat], sInfo.proj);
                total += calcDist(sInfo.proj, roadNetwork.nodes[sNode]);
                for(let i=0; i<path.length-1; i++) total += calcDist(roadNetwork.nodes[path[i]], roadNetwork.nodes[path[i+1]]);
                total += calcDist(roadNetwork.nodes[eNode], eInfo.proj);
                total += calcDist(eInfo.proj, [endData.pos.lng, endData.pos.lat]);

                if (total < minTotalDist) { minTotalDist = total; bestPath = path; }
            });
        });

        let final = [[startData.pos.lat, startData.pos.lng], [sInfo.proj[1], sInfo.proj[0]]];
        bestPath.forEach(id => final.push([roadNetwork.nodes[id][1], roadNetwork.nodes[id][0]]));
        final.push([eInfo.proj[1], eInfo.proj[0]], [endData.pos.lat, endData.pos.lng]);

        routeLine = L.polyline(final, { color: '#ff4757', weight: 7, opacity: 0.8, dashArray: '8, 12' }).addTo(map);
        map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });

        document.getElementById('routeStatus').style.display = "block";
        document.getElementById('routeStatus').innerHTML = `${startData.name} ‚ûî ${endData.name}`;
    }

    // --- 3. UI ‰∫íÂãï ---
    function appendKey(k) { if (currentInput.length < 3) currentInput += k; document.getElementById('combinedInput').value = currentInput; }
    
    function clearInput(fullReset = false) { 
        currentInput = ""; document.getElementById('combinedInput').value = ""; 
        if (activeSpot) { geojsonLayer.resetStyle(activeSpot); activeSpot = null; }
        if (fullReset) { 
            if (routeLine) map.removeLayer(routeLine);
            if (startMarker) map.removeLayer(startMarker);
            if (endMarker) map.removeLayer(endMarker);
            startData = null; endData = null; routeLine = null; startMarker = null; endMarker = null;
            document.getElementById('routeStatus').style.display = "none";
        }
    }

    function toggleKeypad() {
        const keypad = document.getElementById('keypadSection');
        if (!keypad.classList.contains('active')) clearInput(true); // ÂÖ®Ê∏ÖÁ©∫
        keypad.classList.toggle('active');
    }

    function setPoint(type) {
        if (!currentInput || !geojsonLayer) return;
        const targetName = formatInput(currentInput);
        let target = null;
        geojsonLayer.eachLayer(l => { if (l.feature.properties.name.toString().toUpperCase() === targetName) target = l; });
        if (!target) return alert("ÁÑ°Ê≠§Á∑®Ëôü: " + targetName);

        const pos = target.getLatLng ? target.getLatLng() : target.getBounds().getCenter();
        if (type === 'from') {
            startData = { name: targetName, pos };
            if (startMarker) map.removeLayer(startMarker);
            startMarker = L.circleMarker(pos, { radius: 10, color: '#0984e3', fillColor: '#0984e3', fillOpacity: 1 }).addTo(map);
        } else {
            endData = { name: targetName, pos };
            if (endMarker) map.removeLayer(endMarker);
            endMarker = L.marker(pos, { icon: redFlagIcon }).addTo(map);
        }
        if (startData && endData) { drawRoute(); document.getElementById('keypadSection').classList.remove('active'); }
        else { currentInput = ""; document.getElementById('combinedInput').value = ""; }
    }

    function executeSearch() {
        if (!currentInput || !geojsonLayer) return;
        const targetName = formatInput(currentInput);
        geojsonLayer.eachLayer(l => {
            if (l.feature.properties.name.toString().toUpperCase() === targetName) {
                const pos = l.getLatLng ? l.getLatLng() : l.getBounds().getCenter();
                map.setView(pos, 21);
                l.setStyle({ color: '#ff0000', opacity: 1, weight: 4, fillColor: '#ffff00', fillOpacity: 0.7 });
                l.openPopup(); activeSpot = l;
                document.getElementById('keypadSection').classList.remove('active');
            }
        });
    }
</script>
</body>
</html>
