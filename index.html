<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#f0f0f0">
    <title>B2ÂÅúËªäÂ†¥</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="apple-touch-icon" href="icon.png">

    <style>
        body { margin: 0; padding: 0; background: #eee; overflow: hidden; }
        #map { height: 100vh; width: 100vw; background-color: #f0f0f0; }
        
        .search-container {
            position: absolute; top: 15px; left: 15px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95); padding: 12px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.25); width: 260px;
            font-family: sans-serif;
        }
        #routeStatus {
            font-size: 14px; color: #d63031; font-weight: bold; 
            margin-bottom: 8px; text-align: center; display: none;
            background: #fff5f5; padding: 8px; border-radius: 5px;
            border: 1px solid #fab1a0;
        }
        #combinedInput {
            width: 100%; height: 45px; font-size: 22px; text-align: center;
            border: 2px solid #ccc; border-radius: 8px;
            background: #fff; box-sizing: border-box; cursor: pointer;
        }
        .keypad { display: none; flex-direction: column; gap: 6px; margin-top: 10px; }
        .keypad.active { display: flex; }
        .key-row { display: flex; justify-content: space-between; gap: 6px; }
        .key-btn {
            flex: 1; height: 55px; font-size: 18px; font-weight: bold;
            cursor: pointer; border: 1px solid #bbb; border-radius: 8px;
            background: #ffffff; color: #333; display: flex; align-items: center; justify-content: center;
        }
        .key-btn:active { background: #ddd; transform: scale(0.95); }
        .key-btn.letter { background: #f0f7ff; color: #007bff; border-color: #b3d7ff; }
        .key-btn.func-clear { background: #fff5f5; color: #e03131; border-color: #ffa8a8; }
        .key-btn.func-search { background: #f4fce3; color: #2f9e44; border-color: #c0eb75; }
        .key-btn.nav-btn { font-size: 14px; border: 2px solid #bbb; }

        .leaflet-popup-content { font-size: 16px; font-weight: bold; }
    </style>
</head>
<body>

<div class="search-container">
    <div id="routeStatus">
        <span id="txtFrom"></span> ‚ûî <span id="txtTo"></span>
    </div>
    <input type="text" id="combinedInput" placeholder="ÈªûÊìäÊêúÂ∞ã" readonly onclick="toggleKeypad()">
    <div id="keypadSection" class="keypad">
        <div class="key-row">
            <button class="key-btn letter" onclick="appendKey('A')">A</button>
            <button class="key-btn letter" onclick="appendKey('B')">B</button>
            <button class="key-btn letter" onclick="appendKey('C')">C</button>
            <button class="key-btn letter" onclick="appendKey('D')">D</button>
            <button class="key-btn letter" onclick="appendKey('E')">E</button>
        </div>
        <div class="key-row"><button class="key-btn" onclick="appendKey('1')">1</button><button class="key-btn" onclick="appendKey('2')">2</button><button class="key-btn" onclick="appendKey('3')">3</button></div>
        <div class="key-row"><button class="key-btn" onclick="appendKey('4')">4</button><button class="key-btn" onclick="appendKey('5')">5</button><button class="key-btn" onclick="appendKey('6')">6</button></div>
        <div class="key-row"><button class="key-btn" onclick="appendKey('7')">7</button><button class="key-btn" onclick="appendKey('8')">8</button><button class="key-btn" onclick="appendKey('9')">9</button></div>
        <div class="key-row">
            <button class="key-btn func-clear" onclick="clearInput()">Ê∏ÖÈô§</button>
            <button class="key-btn" onclick="appendKey('0')">0</button>
            <button class="key-btn func-search" onclick="executeSearch()">ÊêúÂ∞ã</button>
        </div>
        <div class="key-row" style="margin-top: 5px;">
            <button class="key-btn nav-btn" style="background-color: #ffeaa7;" onclick="setPoint('from')">Ë®≠ÁÇ∫Ëµ∑Èªû</button>
            <button class="key-btn nav-btn" style="background-color: #fab1a0;" onclick="setPoint('to')">Ë®≠ÁÇ∫ÁõÆÊ®ô</button>
        </div>
    </div>
</div>

<div id="map"></div>

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js'); });
    }

    // --- 1. Ë≥áÊñôËàáÂü∫Á§éÂèÉÊï∏ÂÆöÁæ© ---
    const imageBounds = [[22.62193, 120.34105], [22.62406, 120.34360]];
    const roadNetwork = {
        "nodes": {
            "A1": [120.34124, 22.62270], "A3": [120.34137, 22.62307], "A4": [120.34149, 22.62344], "A5": [120.34164, 22.62391],
            "B1": [120.34175, 22.62254], "B3": [120.34188, 22.62290], "B4": [120.34200, 22.62327], "B5": [120.34216, 22.62374],
            "C1": [120.34250, 22.62227], "C2": [120.34256, 22.62244], "C3": [120.34263, 22.62266], "C4": [120.34275, 22.62301], "C5": [120.34291, 22.62348],
            "D1": [120.34308, 22.62208], "D2": [120.34313, 22.62225], "D4": [120.34332, 22.62282], "D5": [120.34347, 22.62329]
        },
        "edges": [
            ["A1","A3"], ["A3","A4"], ["A4","A5"], ["B1","B3"], ["B3","B4"], ["B4","B5"],
            ["C1","C2"], ["C2","C3"], ["C3","C4"], ["C4","C5"], ["D1","D2"], ["D2","D4"], ["D4","D5"],
            ["A1","B1"], ["B1","C1"], ["C1","D1"], ["C2","D2"], ["A3","B3"], ["B3","C3"],
            ["A4","B4"], ["C4","D4"], ["A5","B5"], ["B5","C5"], ["C5","D5"]
        ]
    };

    // Ëá™ÂÆöÁæ©Â§ßÊóóÂ≠êÊ®ôË®ò
    const redFlagIcon = L.divIcon({
        html: '<div style="font-size: 40px; filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.3)); line-height: 1;">üö©</div>',
        className: '',
        iconSize: [48, 48],
        iconAnchor: [12, 42] // ‰øÆÊ≠£Èå®ÈªûÔºåËÆìÊóóÊ°øÂ∞ñÁ´ØÂ∞çÊ∫ñÂùêÊ®ô
    });

    let geojsonLayer, currentInput = "", activeSpot = null;
    let startData = null, endData = null, routeLine = null, startMarker = null, endMarker = null;

    // --- 2. ÂàùÂßãÂåñÂú∞Âúñ ---
    const map = L.map('map', { center: [22.6231, 120.3425], zoom: 18, maxZoom: 24, minZoom: 15, zoomControl: false });
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { opacity: 0.4, maxZoom: 24, maxNativeZoom: 19 }).addTo(map);
    L.imageOverlay('B2-20250921.svg', imageBounds, { opacity: 0.8, interactive: false }).addTo(map);

    fetch('parking.geojson').then(res => res.json()).then(data => {
        geojsonLayer = L.geoJSON(data, {
            pointToLayer: (f, l) => L.circleMarker(l, { radius: 3, fillColor: "#ff9800", color: "#000", weight: 1, opacity: 0.3, fillOpacity: 0.5 }),
            style: () => ({ color: "#3388ff", opacity: 0.1, weight: 1, fillOpacity: 0 }),
            onEachFeature: (f, layer) => layer.bindPopup("ÂêçÁ®±: " + f.properties.name)
        }).addTo(map);
    });

    // --- 3. Ê†∏ÂøÉÂ∞éËà™ÊºîÁÆóÊ≥ï (Dijkstra + ÊäïÂΩ±ÂÑ™Âåñ) ---
    function buildGraph() {
        const graph = {};
        for (let id in roadNetwork.nodes) graph[id] = {};
        roadNetwork.edges.forEach(([u, v]) => {
            const d = Math.sqrt(Math.pow(roadNetwork.nodes[u][0]-roadNetwork.nodes[v][0],2) + Math.pow(roadNetwork.nodes[u][1]-roadNetwork.nodes[v][1],2));
            graph[u][v] = d; graph[v][u] = d;
        });
        return graph;
    }

    function dijkstra(start, end) {
        const graph = buildGraph();
        const dists = {}, prevs = {}, pq = new Set(Object.keys(graph));
        Object.keys(graph).forEach(n => dists[n] = Infinity);
        dists[start] = 0;
        while(pq.size) {
            let u = Array.from(pq).reduce((a, b) => dists[a] < dists[b] ? a : b);
            if (u === end || dists[u] === Infinity) break;
            pq.delete(u);
            for (let v in graph[u]) {
                let alt = dists[u] + graph[u][v];
                if (alt < dists[v]) { dists[v] = alt; prevs[v] = u; }
            }
        }
        const path = []; let curr = end;
        while(curr) { path.unshift(curr); curr = prevs[curr]; }
        return path;
    }

    function getProjectionPoint(P, A, B) {
        const x1 = A[0], y1 = A[1], x2 = B[0], y2 = B[1], px = P.lng, py = P.lat;
        const dx = x2 - x1, dy = y2 - y1;
        if (dx === 0 && dy === 0) return A;
        let t = ((px - x1) * dx + (py - y1) * dy) / (dx * dx + dy * dy);
        t = Math.max(0, Math.min(1, t)); 
        return [x1 + t * dx, y1 + t * dy];
    }

    function getNearestPathInfo(latlng) {
        let minDistance = Infinity, bestInfo = null;
        roadNetwork.edges.forEach(([idA, idB]) => {
            const A = roadNetwork.nodes[idA], B = roadNetwork.nodes[idB];
            const proj = getProjectionPoint(latlng, A, B);
            const d = Math.sqrt(Math.pow(latlng.lng - proj[0], 2) + Math.pow(latlng.lat - proj[1], 2));
            if (d < minDistance) {
                minDistance = d;
                bestInfo = { projPoint: proj, nodes: [idA, idB] };
            }
        });
        return bestInfo;
    }

    function drawRoute() {
        if (routeLine) map.removeLayer(routeLine);
        const startInfo = getNearestPathInfo(startData.pos);
        const endInfo = getNearestPathInfo(endData.pos);
        if (!startInfo || !endInfo) return;

        let shortestRoute = null, minTotalNodes = Infinity;

        // Âà§Êñ∑È†ÜË∑ØÁµÑÂêàÔºåÈÅøÂÖçÊéâÈ†≠
        startInfo.nodes.forEach(sNode => {
            endInfo.nodes.forEach(eNode => {
                const pathNodes = dijkstra(sNode, eNode);
                if (pathNodes.length < minTotalNodes) {
                    minTotalNodes = pathNodes.length;
                    shortestRoute = pathNodes;
                }
            });
        });

        let finalPath = [[startData.pos.lat, startData.pos.lng]];
        finalPath.push([startInfo.projPoint[1], startInfo.projPoint[0]]);
        shortestRoute.forEach(id => finalPath.push([roadNetwork.nodes[id][1], roadNetwork.nodes[id][0]]));
        finalPath.push([endInfo.projPoint[1], endInfo.projPoint[0]]);
        finalPath.push([endData.pos.lat, endData.pos.lng]);

        routeLine = L.polyline(finalPath, { color: '#ff4757', weight: 8, opacity: 0.8, dashArray: '10, 15', lineJoin: 'round' }).addTo(map);
        map.fitBounds(routeLine.getBounds(), { padding: [80, 80] });
    }

    // --- 4. UI ÂäüËÉΩÂáΩÊï∏ ---
    function appendKey(k) { currentInput += k; document.getElementById('combinedInput').value = currentInput; }
    function clearInput() { 
        currentInput = ""; 
        document.getElementById('combinedInput').value = ""; 
        if (activeSpot) geojsonLayer.resetStyle(activeSpot);
        if (routeLine) { 
            map.removeLayer(routeLine); map.removeLayer(startMarker); map.removeLayer(endMarker);
            startData = null; endData = null; routeLine = null; startMarker = null; endMarker = null;
            document.getElementById('routeStatus').style.display = "none";
        }
    }
    function toggleKeypad() { clearInput(); document.getElementById('keypadSection').classList.toggle('active'); }

    function setPoint(type) {
        if (!currentInput || !geojsonLayer) return;
        let target = null;
        geojsonLayer.eachLayer(l => { if (l.feature.properties.name.toString().toUpperCase() === currentInput.toUpperCase()) target = l; });
        if (!target) return alert("Êâæ‰∏çÂà∞Á∑®Ëôü: " + currentInput);

        const pos = target.getLatLng ? target.getLatLng() : target.getBounds().getCenter();
        if (type === 'from') {
            startData = { name: currentInput, pos: pos };
            document.getElementById('txtFrom').innerText = "Ëµ∑Èªû: " + currentInput;
            if (startMarker) map.removeLayer(startMarker);
            startMarker = L.circleMarker(pos, { radius: 10, color: '#0984e3', fillColor: '#0984e3', fillOpacity: 1 }).addTo(map);
        } else {
            endData = { name: currentInput, pos: pos };
            document.getElementById('txtTo').innerText = "ÁõÆÊ®ô: " + currentInput;
            if (endMarker) map.removeLayer(endMarker);
            endMarker = L.marker(pos, { icon: redFlagIcon }).addTo(map);
        }

        document.getElementById('routeStatus').style.display = "block";
        if (startData && endData) { 
            drawRoute(); 
            document.getElementById('keypadSection').classList.remove('active'); 
        } else { 
            currentInput = ""; 
            document.getElementById('combinedInput').value = ""; 
        }
    }

    function executeSearch() {
        if (!currentInput || !geojsonLayer) return;
        geojsonLayer.eachLayer(l => {
            if (l.feature.properties.name.toString().toUpperCase() === currentInput.toUpperCase()) {
                const pos = l.getLatLng ? l.getLatLng() : l.getBounds().getCenter();
                map.setView(pos, 21);
                l.setStyle({ color: '#ff0000', opacity: 1, weight: 4, fillColor: '#ffff00', fillOpacity: 0.7 });
                l.openPopup();
                activeSpot = l;
                document.getElementById('keypadSection').classList.remove('active');
            }
        });
    }

    // Èô§ÈåØÂ∑•ÂÖ∑
    map.on('click', e => { console.log(`"coords": [${e.latlng.lng.toFixed(5)}, ${e.latlng.lat.toFixed(5)}]`); });
</script>
</body>
</html>